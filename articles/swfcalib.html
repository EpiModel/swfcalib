<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="swfcalib">
<title>swfcalib • swfcalib</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="swfcalib">
<meta property="og:description" content="swfcalib">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">swfcalib</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/swfcalib.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>swfcalib</h1>
            
      
      
      <div class="d-none name"><code>swfcalib.Rmd</code></div>
    </div>

    
    
<p><code>swfcalib</code> gives a scaffold to make an automated
calibration system on a <a href="https://slurm.schedmd.com/" class="external-link">Slurm</a>
equipped HPC. <code>swfcalib</code> relies on <a href="https://github.com/EpiModel/slurmworkflow" class="external-link"><code>slurmworkflow</code></a>
and a stored calibration object to chose which step of the calibration
to run. This allows very long calibrations to take place without
flooding the <code>slurm</code> queue.</p>
<p>For this vignette we will take as an example a simplified version of
one of our epidemic models to showcase <code>swfcalib</code> usage.</p>
<p>This model is a network model simulating HIV circulation in a
population of 100k Men who have Sex with Men (MSM).</p>
<div class="section level2">
<h2 id="the-model">The model<a class="anchor" aria-label="anchor" href="#the-model"></a>
</h2>
<p>A single run of our model locally looks like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">EpiModelHIV</span><span class="op">)</span></span>
<span></span>
<span><span class="va">epistats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/epistats.rds"</span><span class="op">)</span></span>
<span><span class="va">netstats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/netstats.rds"</span><span class="op">)</span></span>
<span><span class="va">est</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/netest.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu">param.net</span><span class="op">(</span></span>
<span>  data.frame.params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"data/input/params.csv"</span><span class="op">)</span>,</span>
<span>  netstats          <span class="op">=</span> <span class="va">netstats</span>,</span>
<span>  epistats          <span class="op">=</span> <span class="va">epistats</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">init_msm</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">control_msm</span><span class="op">(</span></span>
<span>  nsteps <span class="op">=</span> <span class="fl">52</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>  nsims  <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ncores <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The actual simulation happens here</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">netsim</span><span class="op">(</span><span class="va">est</span>, <span class="va">param</span>, <span class="va">init</span>, <span class="va">control</span><span class="op">)</span></span></code></pre></div>
<p>In this example, we need to load the <code>EpiModelHIV</code>
package, to read 4 files located in a “data/input” folder and to pass 4
parameters to the <code>netsim</code> function.</p>
<p>The result, stored in the <code>sim</code> variable is not directly
usable by <code>swfcalib</code>.</p>
</div>
<div class="section level2">
<h2 id="calibration-parameters-and-outputs">Calibration parameters and outputs<a class="anchor" aria-label="anchor" href="#calibration-parameters-and-outputs"></a>
</h2>
<p>For this example, we will focus on 9 parameters to calibrate and 9
outputs to fit to there targets.</p>
<p>There are many more parameters in the model. Some get their values
from the literature, other free parameters to be calibrated are ignored
for sake of simplicity in this example.</p>
<div class="section level3">
<h3 id="outputs">Outputs<a class="anchor" aria-label="anchor" href="#outputs"></a>
</h3>
<p>The first outputs are the proportion of HIV individuals who are
diagnosed (i.e. aware of their status).</p>
<p>Then is the proportion of HIV diagnosed who started treatment in less
than a month after diagnosis.</p>
<p>Finally, the prevalence of diagnosed HIV in the population is our
final output of interest.</p>
<p>As our population is race stratified between, black, hispanic and
white, we get three time the number of outputs.</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Output Name</th>
<th>Description</th>
<th>Target Value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>cc.dx.B</td>
<td>Portion of HIV infected who are diagnosed (black)</td>
<td>0.847</td>
</tr>
<tr class="even">
<td>cc.dx.H</td>
<td>Portion of HIV infected who are diagnosed (hispanic)</td>
<td>0.818</td>
</tr>
<tr class="odd">
<td>cc.dx.W</td>
<td>Portion of HIV infected who are diagnosed (white)</td>
<td>0.862</td>
</tr>
<tr class="even">
<td>cc.linked1m.B</td>
<td>Linkage to care within 1 month (black)</td>
<td>0.829</td>
</tr>
<tr class="odd">
<td>cc.linked1m.H</td>
<td>Linkage to care within 1 month (hispanic)</td>
<td>0.898</td>
</tr>
<tr class="even">
<td>cc.linked1m.W</td>
<td>Linkage to care within 1 month (white)</td>
<td>0.881</td>
</tr>
<tr class="odd">
<td>i.prev.dx.B</td>
<td>HIV diagnosed prevalence (black)</td>
<td>0.33</td>
</tr>
<tr class="even">
<td>i.prev.dx.H</td>
<td>HIV diagnosed prevalence (hispanic)</td>
<td>0.127</td>
</tr>
<tr class="odd">
<td>i.prev.dx.W</td>
<td>HIV diagnosed prevalence (W)</td>
<td>0.084</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h3>
<p>9 parameters will be calibrated to fit the model to these target
values:</p>
<ul>
<li>The weekly probability of being tested for HIV.</li>
<li>The weekly probability of starting treatment if diagnosed for
HIV.</li>
<li>A <em>transmission scaler</em> which is a parameter that encompass
all the mechanism affecting transmission that are not explicitly defined
in the model.</li>
</ul>
<table class="table">
<thead><tr class="header">
<th>Parameter Name</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>hiv.test.rate_1</td>
<td>Weekly test rate (black)</td>
</tr>
<tr class="even">
<td>hiv.test.rate_2</td>
<td>Weekly test rate (hispanic)</td>
</tr>
<tr class="odd">
<td>hiv.test.rate_3</td>
<td>Weekly test rate (white)</td>
</tr>
<tr class="even">
<td>tx.init.rate_1</td>
<td>Weekly treatment start rate (black)</td>
</tr>
<tr class="odd">
<td>tx.init.rate_2</td>
<td>Weekly treatment start rate (hispanic)</td>
</tr>
<tr class="even">
<td>tx.init.rate_3</td>
<td>Weekly treatment start rate (white)</td>
</tr>
<tr class="odd">
<td>hiv.trans.scale_1</td>
<td>Transmission scaler (black)</td>
</tr>
<tr class="even">
<td>hiv.trans.scale_2</td>
<td>Transmission scaler (hispanic)</td>
</tr>
<tr class="odd">
<td>hiv.trans.scale_3</td>
<td>Transmission scaler (white)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="relationship-between-parameters-and-outputs">Relationship between parameters and outputs<a class="anchor" aria-label="anchor" href="#relationship-between-parameters-and-outputs"></a>
</h2>
<p>Simply by looking at them, we can see that all the parameters do not
relate to all the outputs in the same way.</p>
<p>The <code>hiv.test.rate</code> parameters directly relate to the
<code>cc.dx</code> outputs (proportion) of diagnosed. Also, no other
parameter in our list would affect these outcomes. Therefore, we have 3
one to one relationship. For each race, the test rate will govern the
diagnosed proportion.</p>
<p>A similar situation can be described for linkage to care
(<code>cc.linked1m</code>) and treatment start rate
<code>tx.init.rate</code>. (the denominator is the number of diagnosed
individuals, making it independent of <code>cc.dx</code>).</p>
<p>The prevalence (<code>i.prev.dx</code>), on the other hand, depends
on all 9 parameters. The proportion of diagnosed influences the number
of treated which then influences the number of individuals able to
transmit. The scalers then affect directly the transmission for one
population. But as they modify the prevalence, they also indirectly
influence the transmission in the other sub populations.</p>
<p>However, once the <code>hiv.test.rate</code> and
<code>tx.init.rate</code> are calibrated and their values fixed,
<code>i.prev.dx</code> only depends on the <code>hiv.trans.scale</code>
parameters. Reducing a 9 parameters 3 outputs problem into a simpler 3
parameters, 3 outputs one.</p>
<p>The following graph illustrate these relationships.</p>
<div class="figure">
<img src="param-output.png" alt=""><p class="caption">Parameters - Output relationship</p>
</div>
</div>
<div class="section level2">
<h2 id="calibration-structure">Calibration structure<a class="anchor" aria-label="anchor" href="#calibration-structure"></a>
</h2>
<p>Knowing these parameters - outputs relationship, we can define a
calibration structure to minimize the number of simulations
required.</p>
<p>A first wave will calibrate simultaneously the 3
<code>hiv.test.rate</code> and the 3 <code>tx.init.rate</code>
parameters. This means that each run of the simulation will test a value
for each of these 6 parameters. This idea is similar <a href="https://en.wikipedia.org/wiki/Factorial_experiment" class="external-link">factorial
experiment design</a> and is only possible because of the independence
between the parameters and their respective outcomes.</p>
<p>After these 6 parameters are calibrated (i.e. given fixed and final
values), the <code>hiv.trans.scale</code> parameters will be calibrated
to fit the <code>i.prev.dx</code> outcomes to their target values.</p>
</div>
<div class="section level2">
<h2 id="waves-and-jobs">Waves and jobs<a class="anchor" aria-label="anchor" href="#waves-and-jobs"></a>
</h2>
<p>To express this structure, we need to define calibration
<em>jobs</em> that are going to be run in parallel within several
<em>waves</em>.</p>
<p>In our example we will have two <em>waves</em>, the first one for the
<code>hiv.test.rate</code> and <code>tx.init.rate</code> parameters and
a second for the <code>hiv.trans.scale</code> parameters.</p>
<div class="section level3">
<h3 id="jobs">Jobs<a class="anchor" aria-label="anchor" href="#jobs"></a>
</h3>
<p>Formally, <code>swfcalib</code> defines a <em>job</em> as a set of
<em>parameters</em> to be calibrated by trying to make a set of
<em>outcomes</em> reach a set of <em>targets</em>.</p>
<p>Each <em>job</em> needs a function to make the next set of
<em>parameter</em> proposals to test as well as a function for checking
if the proposals gave sufficiently good results. This latter function is
in charge of stopping the calibration process for the current job.</p>
</div>
<div class="section level3">
<h3 id="waves">Waves<a class="anchor" aria-label="anchor" href="#waves"></a>
</h3>
<p>A <em>wave</em> is a set of multiple jobs that can be run in parallel
(i.e. independent from one another).</p>
<p>In practice, <code>swfcalib</code> takes the proposals from all the
jobs in a wave, combine them and run one simulation per proposal. If you
have a 3 <em>job wave</em>, each making 10 proposal, only 10 simulations
will be run. On the evaluation step each job will only assess the
quality of it’s own outcomes.</p>
<p>Once all the <em>jobs</em> in a <em>wave</em> are finished, the
system moves to the next one if any, using the parameters calibrated on
the previous ones.</p>
</div>
</div>
<div class="section level2">
<h2 id="implementing-the-model-function">Implementing the <code>model</code> function<a class="anchor" aria-label="anchor" href="#implementing-the-model-function"></a>
</h2>
<p>Now that we have a good conceptual idea how the calibration will go,
we need to make our code compatible with <code>swfcalib</code>.</p>
<p>For the model function it is pretty straightforward. We need a
function with this signature:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># simulation code</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Where <code>proposal</code> is an one row <code>tibble</code> with
each column being a parameter to calibrate. In our case,
<code>proposal</code> is a 1 row 9 columns <code>tibble</code>.</p>
<p>And <code>results</code> is a one row <code>tibble</code> where each
column is an output for the calibration process. In this case,
<code>results</code> must also be a 1 row 9 columns
<code>tibble</code>.</p>
<p>Below is the code for our example.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Load all required elements</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">EpiModelHIV</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">epistats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/epistats.rds"</span><span class="op">)</span></span>
<span>  <span class="va">netstats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/netstats.rds"</span><span class="op">)</span></span>
<span>  <span class="va">est</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/netest.rds"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu">param.net</span><span class="op">(</span></span>
<span>    data.frame.params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"data/input/params.csv"</span><span class="op">)</span>,</span>
<span>    netstats          <span class="op">=</span> <span class="va">netstats</span>,</span>
<span>    epistats          <span class="op">=</span> <span class="va">epistats</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">init_msm</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">control_msm</span><span class="op">(</span></span>
<span>    nsteps <span class="op">=</span> <span class="fl">52</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>    nsims  <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    ncores <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Proposal to scenario -------------------------------------------------------</span></span>
<span>  <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu">EpiModelHPC</span><span class="fu">::</span><span class="fu">swfcalib_proposal_to_scenario</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span></span>
<span>  <span class="va">param_sc</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu">use_scenario</span><span class="op">(</span><span class="va">param</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Run the simulation ---------------------------------------------------------</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">netsim</span><span class="op">(</span><span class="va">est</span>, <span class="va">param_sc</span>, <span class="va">init</span>, <span class="va">control</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Process the results  -------------------------------------------------------</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate_calibration_targets</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">-</span> <span class="fl">52</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>      <span class="va">cc.dx.B</span>, <span class="va">cc.dx.H</span>, <span class="va">cc.dx.W</span>,</span>
<span>      <span class="va">cc.linked1m.B</span>, <span class="va">cc.linked1m.H</span>, <span class="va">cc.linked1m.W</span>,</span>
<span>      <span class="va">i.prev.dx.B</span>, <span class="va">i.prev.dx.H</span>, <span class="va">i.prev.dx.W</span>,</span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return the one row `tibble`</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Several things are of importance here:</p>
<ol style="list-style-type: decimal">
<li>We call <code>library</code> within the function. It is not usual,
but we must remember that this will be run on an <code>sbatch</code> job
from a clean environment. Therefore, the function must load all the
required libraries and files.</li>
<li>We must adapt the <code>proposal</code> to be used by the
simulation. In this case, a helper function
<code>swfcalib_proposal_to_scenario</code> does it. But simply copying
the values from the <code>proposal</code> <code>tibble</code> works as
well.</li>
<li>After the simulation, the outputs must be processed to produce a
correctly formatted <code>tibble</code>. In this case, we take the mean
over the last 52 weeks (1 year) for each of the desired outputs.</li>
</ol>
<p>As the users of <code>swfcalib</code>, we are responsible for the
correct output of <code>model</code>.</p>
<p>Also, <code>model</code> must be a function that run a single
simulation and produce a single set of <code>results</code>. This
function will be run in parallel to test several proposals at once.</p>
</div>
<div class="section level2">
<h2 id="configuring-an-swfcalib-system">Configuring an <code>swfcalib</code> system<a class="anchor" aria-label="anchor" href="#configuring-an-swfcalib-system"></a>
</h2>
<p><code>swfcalib</code> maintain a <code>calib_object</code> that store
the state of the calibration as well as all it needs to operate. This
object is first defined locally and then updated on the HPC as the
calibration progresses.</p>
<p>This object is an <code>R</code> <code>list</code> with 3 elements:
<code>state</code>, <code>config</code> and <code>waves</code>.</p>
<p>We won’t cover <code>state</code> now as it is created by
<code>swfcalib</code> and only edited by it.</p>
<div class="section level3">
<h3 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h3>
<p><code>config</code> is a <code>list</code> with the following
elements:</p>
<ul>
<li>
<code>simulator</code>: the function to calibration
<code>model</code> in our case</li>
<li>
<code>root_directory</code>: where the system will store itself on
the HPC</li>
<li>
<code>n_sims</code>: the number of simulations to run in parallel at
each iteration</li>
<li>
<code>max_iteration</code>: the maximum number of iteration before
stopping the calibration if a satisfactory state is not found. This is a
fail-safe mechanism to avoid consuming HPC resources when the
calibration does not work.</li>
<li>
<code>default_proposal</code>: default values for the calibrated
parameters. This fixes the values for the parameters that are to be
calibrated in later waves. Once a job is finished, the calibrated value
is stored here and used for the next runs</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">config</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  simulator <span class="op">=</span> <span class="va">model</span>,</span>
<span>  root_directory <span class="op">=</span> <span class="st">"data/calib"</span>,</span>
<span>  n_sims <span class="op">=</span> <span class="va">n_sims</span>,</span>
<span>  max_iteration <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  default_proposal <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    hiv.test.rate_1   <span class="op">=</span> <span class="fl">0.004123238</span>,</span>
<span>    hiv.test.rate_2   <span class="op">=</span> <span class="fl">0.003771226</span>,</span>
<span>    hiv.test.rate_3   <span class="op">=</span> <span class="fl">0.005956663</span>,</span>
<span>    tx.init.rate_1    <span class="op">=</span> <span class="fl">0.2981623</span>,</span>
<span>    tx.init.rate_2    <span class="op">=</span> <span class="fl">0.3680919</span>,</span>
<span>    tx.init.rate_3    <span class="op">=</span> <span class="fl">0.358254</span>,</span>
<span>    hiv.trans.scale_1 <span class="op">=</span> <span class="fl">2.470962</span>,</span>
<span>    hiv.trans.scale_2 <span class="op">=</span> <span class="fl">0.4247816</span>,</span>
<span>    hiv.trans.scale_3 <span class="op">=</span> <span class="fl">0.3342994</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="waves-1">Waves<a class="anchor" aria-label="anchor" href="#waves-1"></a>
</h3>
<p><code>waves</code> is a list of <em>waves</em>, with each wave being
a list of jobs</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">waves</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  wave1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    job1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    job2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    job3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  wave2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    job1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    job2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calibration-jobs">Calibration jobs<a class="anchor" aria-label="anchor" href="#calibration-jobs"></a>
</h3>
<p>A calibration <em>job</em> is a <code>list</code> with 6
elements:</p>
<ol style="list-style-type: decimal">
<li>
<code>targets</code>: the name of the outputs to fit (&gt;= 1)</li>
<li>
<code>targets_val</code>: the target values</li>
<li>
<code>params</code>: the names of the parameters to calibrate
(&gt;=1)</li>
<li>
<code>initial_proposals</code>: a <code>tibble</code> with the
values to be tested for the first run of the simulation.</li>
<li>
<code>make_next_proposals</code>: a function that will define which
proposals to make next</li>
<li>
<code>get_result</code>: a function to define is the calibration is
done for this job</li>
</ol>
<p>We will get into the details of these elements later on.</p>
<p>Below is an example of the <em>job</em> for calibrating the
<code>hiv.trans.scale</code> parameters using the <code>i.prev.dx</code>
outputs.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">job1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"i.prev.dx."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"H"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  targets_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.33</span>, <span class="fl">0.127</span>, <span class="fl">0.09</span><span class="op">)</span>,</span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"hiv.trans.scale_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    hiv.trans.scale_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    hiv.trans.scale_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    hiv.trans.scale_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  make_next_proposals <span class="op">=</span></span>
<span>    <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">make_proposer_se_range</span><span class="op">(</span><span class="va">n_sims</span>, retain_prop <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>  get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_end_thresh</span><span class="op">(</span></span>
<span>    thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    n_enough <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="complete-configuration">Complete configuration<a class="anchor" aria-label="anchor" href="#complete-configuration"></a>
</h3>
<p>Below is the complete <code>calib_object</code> defined locally. Note
that we define an <code>n_sims</code> variable at the beginning and
reuse it all over the configuration to ensure that we have the correct
number of proposals at each step.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_sims</span>  <span class="op">&lt;-</span> <span class="fl">400</span></span>
<span></span>
<span><span class="va">calib_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  config <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    simulator <span class="op">=</span> <span class="va">model</span>,</span>
<span>    default_proposal <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      hiv.test.rate_1   <span class="op">=</span> <span class="fl">0.004123238</span>,</span>
<span>      hiv.test.rate_2   <span class="op">=</span> <span class="fl">0.003771226</span>,</span>
<span>      hiv.test.rate_3   <span class="op">=</span> <span class="fl">0.005956663</span>,</span>
<span>      tx.init.rate_1    <span class="op">=</span> <span class="fl">0.2981623</span>,</span>
<span>      tx.init.rate_2    <span class="op">=</span> <span class="fl">0.3680919</span>,</span>
<span>      tx.init.rate_3    <span class="op">=</span> <span class="fl">0.358254</span>,</span>
<span>      hiv.trans.scale_1 <span class="op">=</span> <span class="fl">2.470962</span>,</span>
<span>      hiv.trans.scale_2 <span class="op">=</span> <span class="fl">0.4247816</span>,</span>
<span>      hiv.trans.scale_3 <span class="op">=</span> <span class="fl">0.3342994</span></span>
<span>    <span class="op">)</span>,</span>
<span>    root_directory <span class="op">=</span> <span class="st">"data/calib"</span>,</span>
<span>    max_iteration <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    n_sims <span class="op">=</span> <span class="va">n_sims</span></span>
<span>  <span class="op">)</span>,</span>
<span>  waves <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    wave1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      job1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="st">"cc.dx.B"</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fl">0.847</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hiv.test.rate_1"</span><span class="op">)</span>, <span class="co"># target: 0.00385</span></span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.test.rate_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.002</span>, <span class="fl">0.006</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      job2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="st">"cc.dx.H"</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fl">0.818</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hiv.test.rate_2"</span><span class="op">)</span>, <span class="co"># target: 0.0038</span></span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.test.rate_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.002</span>, <span class="fl">0.006</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>      job3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="st">"cc.dx.W"</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fl">0.862</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hiv.test.rate_3"</span><span class="op">)</span>, <span class="co"># target: 0.0069</span></span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.test.rate_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.004</span>, <span class="fl">0.008</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      job4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cc.linked1m."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"H"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.829</span>, <span class="fl">0.898</span>, <span class="fl">0.881</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tx.init.rate_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          tx.init.rate_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          tx.init.rate_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tx.init.rate_1</span><span class="op">)</span>,</span>
<span>          tx.init.rate_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tx.init.rate_1</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    wave2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      job1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"i.prev.dx."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"H"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.33</span>, <span class="fl">0.127</span>, <span class="fl">0.09</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"hiv.trans.scale_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.trans.scale_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          hiv.trans.scale_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          hiv.trans.scale_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span></span>
<span>          <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">make_proposer_se_range</span><span class="op">(</span><span class="va">n_sims</span>, retain_prop <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_end_thresh</span><span class="op">(</span></span>
<span>          thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>          n_enough <span class="op">=</span> <span class="fl">100</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="proposers-and-calibration-check">Proposers and calibration check<a class="anchor" aria-label="anchor" href="#proposers-and-calibration-check"></a>
</h2>
<p>As mentioned earlier, each calibration <em>job</em> needs a function
to define which proposal to make at the next iteration
(<code>make_next_proposals</code>) and a function to assess if the
calibration is finished (<code>get_result</code>).</p>
<p>We won’t get into the details of how these functions work but focus
instead on their practical use. You can have a look at their respective
documentation for more details.</p>
<div class="section level3">
<h3 id="hiv-test-rate">HIV test rate<a class="anchor" aria-label="anchor" href="#hiv-test-rate"></a>
</h3>
<p>The 3 <em>jobs</em> related to <code>hiv.test.rate</code> and
proportion of diagnosed among infected (<code>cc.dx</code>) use the same
approach:</p>
<p>The proposer function is generated by a <a href="https://adv-r.hadley.nz/function-factories.html" class="external-link">function
factory</a>: <code>make_shrink_proposer(n_sims, shrink = 2)</code>. This
proposer will shrink the range of proposals by a factor 2 around the
best guess so far.</p>
<p>The calibration assessor is made by
<code>determ_poly_end(0.001, poly_n = 5)</code>. This function uses
linear model with a degree 5 polynomial to predict the best value for
the parameter. The calibration is considered finished when the predicted
value is less than <code>threshold</code> away from the target (here
<code>0.001</code>) AND when the prediction is not improving after the
last iteration.</p>
</div>
<div class="section level3">
<h3 id="linkage-to-care">Linkage to care<a class="anchor" aria-label="anchor" href="#linkage-to-care"></a>
</h3>
<p>Linkage to care uses the same functions but all 3 parameters and
targets are fitted at once. This here implies that a single model is
fitted for all the data. It works very well in this specific case as the
relationship between linkage to care and treatment uptake rate is
consistent over the three groups.</p>
</div>
<div class="section level3">
<h3 id="hiv-prevalence">HIV prevalence<a class="anchor" aria-label="anchor" href="#hiv-prevalence"></a>
</h3>
<p>HIV prevalence and transmission scale is harder to calibrate as the 3
parameters and outputs are linked together.</p>
<p>At each iteration the squared error over all 3 targets is calculated
for each proposal. The ranges for the next round of proposals are the
ranges of these best 30% proposals of the previous rounds. The function
factory here is <code>make_proposer_se_range</code>. It takes a
<code>retain_prop</code> argument that governs which proportion of the
simulations are used to define the new ranges.</p>
<p>The calibration is considered done when 100 simulations where the 3
outputs are less than <code>thresholds</code> away from there respective
targets. The <code>determ_end_thresh</code> function factory allow us to
define the number of <em>good</em> simulations required and the
thresholds for each output.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-a-calibration-system">Running a calibration system<a class="anchor" aria-label="anchor" href="#running-a-calibration-system"></a>
</h2>
<p>Now that all the pieces are ready, we can setup the workflow using
the <a href="https://github.com/EpiModel/slurmworkflow" class="external-link"><code>slurmworkflow</code></a>
package.</p>
<p>This will allow the HPC to run the calibration steps in a loop until
the calibration is finished.</p>
<p>The following script setup a complete calibration workflow with what
was defined so far.</p>
<p>The main thing you may want to change in this script is the
<code>batch_size</code> variable that governs how many sims are run in
parallel on a single cluster. On the RSPH HPC we set it to 8. Therefore,
50 batches of 8 are submitted to <code>slurm</code> at once to make the
400 simulations requested per iteration.</p>
<p>A mail is sent if a job fails or at the end of the 3rd calibration
step. This latter indicate that the calibration process is done.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://epimodel.github.io/slurmworkflow/" class="external-link">"slurmworkflow"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the `model` function</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Load all required elements</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">EpiModelHIV</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">epistats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/epistats.rds"</span><span class="op">)</span></span>
<span>  <span class="va">netstats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/netstats.rds"</span><span class="op">)</span></span>
<span>  <span class="va">est</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/input/netest.rds"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu">param.net</span><span class="op">(</span></span>
<span>    data.frame.params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"data/input/params.csv"</span><span class="op">)</span>,</span>
<span>    netstats          <span class="op">=</span> <span class="va">netstats</span>,</span>
<span>    epistats          <span class="op">=</span> <span class="va">epistats</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">init_msm</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">control_msm</span><span class="op">(</span></span>
<span>    nsteps <span class="op">=</span> <span class="fl">52</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>    nsims  <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    ncores <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Proposal to scenario -------------------------------------------------------</span></span>
<span>  <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu">EpiModelHPC</span><span class="fu">::</span><span class="fu">swfcalib_proposal_to_scenario</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span></span>
<span>  <span class="va">param_sc</span> <span class="op">&lt;-</span> <span class="fu">EpiModel</span><span class="fu">::</span><span class="fu">use_scenario</span><span class="op">(</span><span class="va">param</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Run the simulation ---------------------------------------------------------</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">netsim</span><span class="op">(</span><span class="va">est</span>, <span class="va">param_sc</span>, <span class="va">init</span>, <span class="va">control</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Process the results  -------------------------------------------------------</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate_calibration_targets</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">-</span> <span class="fl">52</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>      <span class="va">cc.dx.B</span>, <span class="va">cc.dx.H</span>, <span class="va">cc.dx.W</span>,</span>
<span>      <span class="va">cc.linked1m.B</span>, <span class="va">cc.linked1m.H</span>, <span class="va">cc.linked1m.W</span>,</span>
<span>      <span class="va">i.prev.dx.B</span>, <span class="va">i.prev.dx.H</span>, <span class="va">i.prev.dx.W</span>,</span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Return the one row `tibble`</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create the `calib_object`</span></span>
<span><span class="va">n_sims</span>  <span class="op">&lt;-</span> <span class="fl">400</span></span>
<span><span class="va">calib_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  config <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    simulator <span class="op">=</span> <span class="va">model</span>,</span>
<span>    default_proposal <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      hiv.test.rate_1   <span class="op">=</span> <span class="fl">0.004123238</span>,</span>
<span>      hiv.test.rate_2   <span class="op">=</span> <span class="fl">0.003771226</span>,</span>
<span>      hiv.test.rate_3   <span class="op">=</span> <span class="fl">0.005956663</span>,</span>
<span>      tx.init.rate_1    <span class="op">=</span> <span class="fl">0.2981623</span>,</span>
<span>      tx.init.rate_2    <span class="op">=</span> <span class="fl">0.3680919</span>,</span>
<span>      tx.init.rate_3    <span class="op">=</span> <span class="fl">0.358254</span>,</span>
<span>      hiv.trans.scale_1 <span class="op">=</span> <span class="fl">2.470962</span>,</span>
<span>      hiv.trans.scale_2 <span class="op">=</span> <span class="fl">0.4247816</span>,</span>
<span>      hiv.trans.scale_3 <span class="op">=</span> <span class="fl">0.3342994</span></span>
<span>    <span class="op">)</span>,</span>
<span>    root_directory <span class="op">=</span> <span class="st">"data/calib"</span>,</span>
<span>    max_iteration <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    n_sims <span class="op">=</span> <span class="va">n_sims</span></span>
<span>  <span class="op">)</span>,</span>
<span>  waves <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    wave1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      job1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="st">"cc.dx.B"</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fl">0.847</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hiv.test.rate_1"</span><span class="op">)</span>, <span class="co"># target: 0.00385</span></span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.test.rate_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.002</span>, <span class="fl">0.006</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      job2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="st">"cc.dx.H"</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fl">0.818</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hiv.test.rate_2"</span><span class="op">)</span>, <span class="co"># target: 0.0038</span></span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.test.rate_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.002</span>, <span class="fl">0.006</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>      job3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="st">"cc.dx.W"</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fl">0.862</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hiv.test.rate_3"</span><span class="op">)</span>, <span class="co"># target: 0.0069</span></span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.test.rate_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.004</span>, <span class="fl">0.008</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      job4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cc.linked1m."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"H"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.829</span>, <span class="fl">0.898</span>, <span class="fl">0.881</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tx.init.rate_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          tx.init.rate_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          tx.init.rate_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tx.init.rate_1</span><span class="op">)</span>,</span>
<span>          tx.init.rate_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tx.init.rate_1</span><span class="op">)</span>,</span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu"><a href="../reference/make_shrink_proposer.html">make_shrink_proposer</a></span><span class="op">(</span><span class="va">n_sims</span>, shrink <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_poly_end</span><span class="op">(</span><span class="fl">0.001</span>, poly_n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    wave2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      job1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"i.prev.dx."</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"H"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        targets_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.33</span>, <span class="fl">0.127</span>, <span class="fl">0.09</span><span class="op">)</span>,</span>
<span>        params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"hiv.trans.scale_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>        initial_proposals <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>          hiv.trans.scale_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          hiv.trans.scale_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          hiv.trans.scale_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.6</span>, length.out <span class="op">=</span> <span class="va">n_sims</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        make_next_proposals <span class="op">=</span></span>
<span>          <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">make_proposer_se_range</span><span class="op">(</span><span class="va">n_sims</span>, retain_prop <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        get_result <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="fu">determ_end_thresh</span><span class="op">(</span></span>
<span>          thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>          n_enough <span class="op">=</span> <span class="fl">100</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Workflow ---------------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># Use preconfigured HPC settings</span></span>
<span><span class="va">hpc_configs</span> <span class="op">&lt;-</span> <span class="fu">EpiModelHPC</span><span class="fu">::</span><span class="fu">swf_configs_rsph</span><span class="op">(</span></span>
<span>  partition <span class="op">=</span> <span class="st">"epimodel"</span>,</span>
<span>  r_version <span class="op">=</span> <span class="st">"4.3"</span>,</span>
<span>  mail_user <span class="op">=</span> <span class="st">"&lt;your_user&gt;@emory.edu"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/create_workflow.html" class="external-link">create_workflow</a></span><span class="op">(</span></span>
<span>  wf_name <span class="op">=</span> <span class="st">"Vignette_auto_calib"</span>,</span>
<span>  default_sbatch_opts <span class="op">=</span> <span class="va">hpc_configs</span><span class="op">$</span><span class="va">default_sbatch_opts</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibration step 1</span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/add_workflow_step.html" class="external-link">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/step_tmpl_do_call.html" class="external-link">step_tmpl_do_call</a></span><span class="op">(</span></span>
<span>    what <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="va"><a href="../reference/calibration_step1.html">calibration_step1</a></span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_cores <span class="op">=</span> <span class="fl">8</span>,</span>
<span>      calib_object <span class="op">=</span> <span class="va">calib_object</span></span>
<span>    <span class="op">)</span>,</span>
<span>    setup_lines <span class="op">=</span> <span class="va">hpc_configs</span><span class="op">$</span><span class="va">r_loader</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="st">"00:20:00"</span>,</span>
<span>    <span class="st">"mem-per-cpu"</span> <span class="op">=</span> <span class="st">"4G"</span>,</span>
<span>    <span class="st">"mail-type"</span> <span class="op">=</span> <span class="st">"FAIL"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibration step 2</span></span>
<span><span class="va">batch_size</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">batch_numbers</span> <span class="op">&lt;-</span> <span class="fu">swfcalib</span><span class="fu">:::</span><span class="fu">get_batch_numbers</span><span class="op">(</span><span class="va">calib_object</span>, <span class="va">batch_size</span><span class="op">)</span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/add_workflow_step.html" class="external-link">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/step_tmpl_map.html" class="external-link">step_tmpl_map</a></span><span class="op">(</span></span>
<span>    FUN <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="va"><a href="../reference/calibration_step2.html">calibration_step2</a></span>,</span>
<span>    batch_num <span class="op">=</span> <span class="va">batch_numbers</span>,</span>
<span>    setup_lines <span class="op">=</span> <span class="va">hpc_configs</span><span class="op">$</span><span class="va">r_loader</span>,</span>
<span>    max_array_size <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_cores <span class="op">=</span> <span class="va">batch_size</span>,</span>
<span>      n_batches <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">batch_numbers</span><span class="op">)</span>,</span>
<span>      calib_object <span class="op">=</span> <span class="va">calib_object</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="va">batch_size</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="st">"05:00:00"</span>,</span>
<span>    <span class="st">"mem-per-cpu"</span> <span class="op">=</span> <span class="st">"5G"</span>,</span>
<span>    <span class="st">"mail-type"</span> <span class="op">=</span> <span class="st">"FAIL"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibration step 3</span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/add_workflow_step.html" class="external-link">add_workflow_step</a></span><span class="op">(</span></span>
<span>  wf_summary <span class="op">=</span> <span class="va">wf</span>,</span>
<span>  step_tmpl <span class="op">=</span> <span class="fu"><a href="https://epimodel.github.io/slurmworkflow/reference/step_tmpl_do_call.html" class="external-link">step_tmpl_do_call</a></span><span class="op">(</span></span>
<span>    what <span class="op">=</span> <span class="fu">swfcalib</span><span class="fu">::</span><span class="va"><a href="../reference/calibration_step3.html">calibration_step3</a></span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      calib_object <span class="op">=</span> <span class="va">calib_object</span></span>
<span>    <span class="op">)</span>,</span>
<span>    setup_lines <span class="op">=</span> <span class="va">hpc_configs</span><span class="op">$</span><span class="va">r_loader</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sbatch_opts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"cpus-per-task"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    <span class="st">"time"</span> <span class="op">=</span> <span class="st">"00:20:00"</span>,</span>
<span>    <span class="st">"mem-per-cpu"</span> <span class="op">=</span> <span class="st">"8G"</span>,</span>
<span>    <span class="st">"mail-type"</span> <span class="op">=</span> <span class="st">"END"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Adrien Le Guillou.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
